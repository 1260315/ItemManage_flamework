<!DOCTYPE html>
<html lang="ja">
<header>
    <meta charset="UTF-8">
    <title>備品管理システム</title>
</header>

<div style="text-align: center;">
    <h1>備品登録・削除業務</h1>
</div>



<body>
    
    <form id="searchForm" method="get" action="/items" onkeydown="return event.key !== 'Enter';" onsubmit="return submitSearchForm(event);">
        <table style="margin-left: auto; margin-right: auto;">
            <tr>
                <td><input type="text" name="id" placeholder="備品ID" value="{{ request.args.get('id','') }}"></td>
                <td><input type="text" name="name" placeholder="備品名" value="{{ request.args.get('name','') }}"></td>
            </tr>
            <tr>
                <td><input type="text" name="created_at" placeholder="登録日" value="{{ request.args.get('created_at','') }}"></td>
                <td><input type="text" name="registrant_id" placeholder="登録者" value="{{ request.args.get('registrant_id','') }}"></td>
            </tr>
        </table>
        <div style="text-align: center;">
            <p>カテゴリ:<br>
                <input name="category_id[]" value="1" type="checkbox" {% if "1" in request.args.getlist('category_id[]' ) %}checked{%endif%}>PC
                <input name="category_id[]" value="2" type="checkbox" {% if "2" in request.args.getlist('category_id[]' ) %}checked{%endif%}>モニター
                <input name="category_id[]" value="3" type="checkbox" {% if "3" in request.args.getlist('category_id[]' ) %}checked{%endif%}>マウス
                <input name="category_id[]" value="4" type="checkbox" {% if "4" in request.args.getlist('category_id[]' ) %}checked{%endif%}>キーボード
                <input name="category_id[]" value="5" type="checkbox" {% if "5" in request.args.getlist('category_id[]' ) %}checked{%endif%}>プリンター
                <input name="category_id[]" value="6" type="checkbox" {% if "6" in request.args.getlist('category_id[]' ) %}checked{%endif%}>その他
            </p>
            <input type="submit" value="検索">
        </div><br>
    </form>
        {% if rows %}
        <table id="ages" border="1" style="margin-left: auto; margin-right: auto;">
        <tr>
            <th>備品ID <button class="sortBtn" style="width: 1.5em; height: 1.5em; text-align: center;padding: 0;" type="button" data-sort="items.id" >{%if session.sortOrder != "items.id"%} {% elif session.sortDirection%}▼{% else %}▲{% endif %}</button></th>
            <th>備品名 <button class="sortBtn" style="width: 1.5em; height: 1.5em; text-align: center;padding: 0;" type="button" data-sort="items.name" >{%if session.sortOrder != "items.name" %} {% elif session.sortDirection%}▼{% else %}▲{% endif %}</button></th>
            <th>登録日 <button class="sortBtn" style="width: 1.5em; height: 1.5em; text-align: center;padding: 0;" type="button" data-sort="items.created_at" >{%if session.sortOrder != "items.created_at" %} {% elif session.sortDirection%}▼{% else %}▲{% endif %}</button></th>
            <th>登録者 <button class="sortBtn" style="width: 1.5em; height: 1.5em; text-align: center;padding: 0;" type="button" data-sort="items.registrant_id" >{%if session.sortOrder != "items.registrant_id" %} {% elif session.sortDirection%}▼{% else %}▲{% endif %}</button></th>
            <th>カテゴリ <!--<button class="sortBtn" style="width: 1.5em; height: 1.5em; text-align: center;padding: 0;" type="button" data-sort="category_id">{%if session.sortOrder != "category_id" %} {% elif session.sortDirection%}▼{% else %}▲{% endif %}</button>--></th>
            <th>備考</th>
            <th>編集</th>
            <th>削除</th>
        </tr>
        {% for row in rows %}
        <tr>
            {% for key, value in row.items() %}
            <td>
                {{ value }}
            </td>
            {% endfor %}
            <td>
                {% if session.studentID|string == row.reg|string or session.authority == 0 %}
                <form method="get" action="/edit_item" style="display: inline;">
                <button type="submit" name="id" value="{{row.id}}">編集</button>
                </form>
                {% endif %}
            </td>
            <td>
                {% if session.studentID|string == row.reg|string or session.authority == 0 %}
                <form method="get" action="/delete_item" style="display: inline;">
                <button type="submit" name="del" value="{{row.id}}">削除</button>
                </form>
                {% endif %}
            </td>
            
        </tr>
        {% endfor %}
        </table>
        {%else%}
        <div style="text-align: center; font-size: larger;">検索に何もヒットしませんでした．</div>
        {%endif%}
</body>
<script>
// ソートボタン押下時に検索条件を維持して GET
function submitSearchForm(event) {
    event.preventDefault();  // 標準の送信を止める

    const form = document.getElementById("searchForm");
    const formData = new FormData(form);
    const params = new URLSearchParams();

    for (const [key, value] of formData.entries()) {
        if (value.trim() !== "") {
            params.append(key, value);
        }
    }

    const urlParams = new URLSearchParams(window.location.search);
    const sort = urlParams.get("sort");
    if (sort) {
        params.set("sort", sort);  // 上書きでも OK
    }
    params.set('do_sort',"0");
    window.location.href = form.action + "?" + params.toString();
    return false; // 念のため
}

document.querySelectorAll('.sortBtn').forEach(btn => {
    btn.addEventListener('click', function() {
        const form = document.getElementById("searchForm");
        const formData = new FormData(form);
        const params = new URLSearchParams();

        // 空の値を除外してURLパラメータに追加
        for (const [key, value] of formData.entries()) {
            if (value.trim() !== "") {
                params.append(key, value);
            }
        }
        params.set('sort', btn.dataset.sort);
        params.set('do_sort',"1");
        window.location.href = "/items" + "?" + params.toString();
    });
});
</script>
</html>