<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>備品管理システム - 備品一覧</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>





<body>
    {% include 'header.html' %}

    <div class="container-s">
        <h1>備品一覧</h1>
    

    <form id="searchForm" method="get" action="/items" 
      onkeydown="return event.key !== 'Enter';" >
      <p>OR：OR検索、_（スペース）：AND検索、"OR"、" "：文字列自体を検索</p>
    <div class="search-container">
        <div class="search-group">
            <input type="text" id="id" name="id" 
                   placeholder="備品ID" 
                   value="{{ request.args.get('id','') }}">
        </div>

        <div class="search-group">
            <input type="text" id="name" name="name" 
                   placeholder="備品名" 
                   value="{{ request.args.get('name','') }}">
        </div>

        <div class="search-group">
            <input type="text" id="created_at" name="created_at" 
                   placeholder="登録日" 
                   value="{{ request.args.get('created_at','') }}">
        </div>

        <div class="search-group">
            <input type="text" id="registrant_id" name="registrant_id" 
                   placeholder="登録者" 
                   value="{{ request.args.get('registrant_id','') }}">
        </div>
    </div>
    <div class="form-group">
        <fieldset>
            <legend>カテゴリー:</legend>
            <div class="categories">
                {% for category in categories %}
                    <label>
                        <input type="checkbox" name="category_id[]" value="{{ category.id }}" {% if  category.id|string in request.args.getlist('category_id[]' ) %}checked{%endif%}>{{ category.name }}
                    </label>
                {% endfor %}
            </div>
        </fieldset>
    </div>
                <div class="form-group">
                    <button type="submit" class="searchBtn">検索</button>
                </div>
            <br>
        </form>
            
            <div  id="results"></div>
  
            </div>
    <script>
        
    document.addEventListener("DOMContentLoaded", () => {
    const form = document.getElementById("searchForm");
    console.log(form)
    const resultsDiv = document.getElementById("results");
    

    // アニメーション関数
    function animateButton(btn) {
        btn.classList.add('hover-effect');
        setTimeout(() => btn.classList.remove('hover-effect'), 150);
    }

    // ===== グローバル状態 =====
    let currentSortKey = null; 
    let currentSortDirection = 0; // 0=昇順, 1=降順

    const searchBtn = document.querySelector('#searchForm button[type="submit"]');

    form.addEventListener("submit", e => {
        e.preventDefault();
        searchBtn.classList.add('activate');

        setTimeout(() => {
            searchBtn.classList.remove('activate');
            fetchResults({ doSort: false });
        }, 50); // アニメーション時間に合わせる
    });
    // ===== ソートボタン =====
    resultsDiv.addEventListener("click", e => {
        const btn = e.target.closest(".sortBtn");
        if (!btn) return;

        animateButton(btn);
        const clickedKey = btn.dataset.sort;

        if (clickedKey === currentSortKey) {
            // 同じカラムならトグル
            currentSortDirection = currentSortDirection === 0 ? 1 : 0;
        } else {
            // 違うカラムなら昇順にリセット
            currentSortKey = clickedKey;
            currentSortDirection = 0;
        }

        fetchResults({ doSort: currentSortDirection, sortKey: currentSortKey });
    });

    // ===== 共通処理 =====
    function fetchResults({ doSort = null, sortKey = null }) {
        const formData = new FormData(form);

        if (sortKey) formData.set("sort", sortKey);
        if (doSort !== null) formData.set("do_sort", doSort.toString());

        // URLSearchParams に詰める
        const params = new URLSearchParams();
        for (const [key, value] of formData.entries()) {
            if (value.trim() !== "") params.append(key, value);
        }

        // URL 更新
        const newUrl = `${form.action}?${params.toString()}`;
        history.replaceState(null, "", newUrl);

        // fetch で結果取得
        fetch(newUrl, {
            method: "GET",
            headers: { "X-Requested-With": "XMLHttpRequest" }
        })
        .then(res => res.ok ? res.text() : Promise.reject("通信エラー"))
        .then(html => resultsDiv.innerHTML = html)
        .catch(err => console.error(err));
    }

    // ===== 初回アクセス時に一覧表示 =====
    fetchResults({ doSort: null });
});
</script>


</body>
</html>